Real Time Bidding Algorithms for Performance Based
Display Ad Allocation
Ye Chen Microsoft yec@microsoft.com
Bo Anderson
Microsoft brighama@microsoft.com
ABSTRACT We describe a real time bidding algorithm for performancebased display ad allocation . A central issue in performance display advertising is matching campaigns to ad impressions , which can be formulated as a constrained optimization problem that maximizes revenue subject to constraints such as budget limits and inventory availability . The current practice is to solve the optimization problem offline at a tractable level of impression granularity ( eg , the placement level ) , and to serve ads online based on the precomputed static delivery scheme . Although this offline approach takes a global view to achieve optimality , it fails to scale to ad delivery decision making at an individual impression level . Therefore , we propose a real time bidding algorithm that enables fine grained impression valuation ( eg , targeting users with real time conversion data ) , and adjusts value based bid according to real time constraint snapshot ( eg , budget consumption level ) . Theoretically , we show that under a linear programming ( LP ) primal dual formulation , the simple real time bidding algorithm is indeed an online solver to the original primal problem by taking the optimal solution to the dual problem as input . In other words , the online algorithm guarantees the offline optimality given the same level of knowledge an offline optimization would have . Empirically , we develop and experiment with two real time bid adjustment approaches to adapting to the non stationary nature of the marketplace : one adjusts bids against real time constraint satisfaction level using control theoretic methods , and the other adjusts bids also based on the historical bidding landscape statistically modeled . Finally , we show experimental results with real world ad serving data .
1 .
INTRODUCTION
In this paper we consider the problem of performancebased display ad allocation . The goal is to match campaigns ( demand side ) to ad impressions ( supply side ) such that the
Pavel Berkhin
Microsoft pavelbe@microsoft.com
Nikhil R . Devanur Microsoft Research nikdev@microsoft.com total revenue from a publisher ’s perspective ( also referred to as yield ) is maximized , while satisfying the constraints primarily imposed by campaign budget and supply inventory availability . In performance based display advertising , there are two major pricing models , namely cost per click ( CPC ) and cost per action ( CPA ) . At an abstract level , advertisers place their bids in the form of CPC or CPA prices on ad impression opportunities from publishers , an ad serving system makes delivery decisions based on advertisers bids , estimated click through rate ( CTR ) or conversion rate ( CVR ) , and relevant constraints , and then advertisers only pay publishers for performance based metrics , ie , clicks or conversions on their ads . Without loss of generality , we will focus our discussion on an abstract one sided marketplace of advertisers , with only one publisher and no intermediaries ( eg , ad networks ) . We further assume that an ad delivery system is optimizing revenue on behalf of the publisher , as well as use CPC campaigns for illustration purpose .
Under an unconstrained environment , particularly if advertisers have unlimited budget , the revenue optimal allocation mechanism is to simply assign each impression to the campaign with highest expected revenue per impression ( eCPI = CTR × CPC ) . However , it can be trivially shown that this na¨ıve mechanism is suboptimal under a constrained setting where demand side constraints exist . The current practice is to solve a constrained optimization problem offline ( see Section 6 for a formal account ) , and use the static optimal allocation to guide ad delivery . The constrained optimization is formulated as a linear programming ( LP ) problem , where the total revenue is maximized with respect to impression allocations subject to linearized constraints . Although an offline optimization takes a global view to achieve revenue optimality at a certain aggregated level , this approach has considerable limitations as follows .
1 . An offline global optimization can only be solved at a tractable level of impression granularity . In the current formulation of performance optimization for one large display network for instance , impressions are allocated at the campaign placement level , there are about 1M decision variables and 0.5M constraints . Impressions within each node of this granularity are treated homogeneous in term of valuation , therefore finer grained impression data cannot be leveraged . Some of these impression level opportunities are known to be differentiating , such as user historical behavior [ 5 ] .
2 . Even if some constraints are inherently at an aggre gated level , such as campaign level budget constraints and placement level traffic volume , the offline optimization will still soon become intractable as the number of advertisers and publishers becomes very large , as in ad exchanges [ 14 ] .
3 . Since the offline optimization can only creates a static allocation scheme , it lacks a natural way to adapt to the marketplace dynamics . In particular , when the distribution from which winning bids are drawn ( bidding landscape ) changes and the campaign goal is over or under delivered as a consequence , an offline algorithm has no mechanism to adjust accordingly [ 7 ] .
Motivated by the limitations of the current approach and the emergence of ad exchanges for clearing performance display ads [ 14 ] , we develop a real time bidding algorithm that enables fine grained or even individual impression valuation while preserving the offline revenue optimality . The realtime bidding algorithm is not only elegant but also wellgrounded on the duality principle . It turns out that the simple online algorithm solves the original offline optimization problem as the primal by taking the optimal solution to the dual as input , ie , the bid adjustment term . The dual optimal thus bears natural interpretation , that is , the shadow price of an extra unit of the primal constraint . With this theoretical foundation from a static perspective , the bidding algorithm requires two key predictive components to account for the dynamic nature of a marketplace .
1 . Impression valuation is a function that returns the expected value of an impression to a bidder ( advertiser or campaign ) given relevant impression level and demand side data , which takes the form : eCPI = CTR × CPC ,
( 1 ) where eCPI stands for expected cost per impression , and shall be the optimal bid in an unconstrained environment . The CPC price is a constant wrt a given campaign . The critical task is to estimate the clickthrough rate ( CTR ) :
CTR = p(click|campaign,impression ) ,
( 2 ) where impression in the conditional side encodes relevant impression level data including user , and campaign encodes demand side data . The problem of estimating CTR is reasonably well studied [ 1 , 5 , 8 ] . For a real time bidding algorithm , a CTR model shall leverage fine grained and real time predictor variables , usually high dimensional and sparse , and perform online prediction efficiently , eg , in 10 ’s milliseconds [ 14 ] . While we will not focus on building a CTR predictive model , we follow the art and use a regression based model .
2 . Real time bid adjustment is to adjust the value based bid according to ( 1 ) the bidding landscape so far , and ( 2 ) the current constraint satisfaction level . We propose an additive bid adjustment as follows . bid = eCPI − α ,
( 3 ) where α is the bid adjustment term . Intuitively , when the bidding landscape becomes more competitive ( ie , the probability of winning becomes lower given a same bid ) , and there are more impressions to acquire to satisfy constraints , α should be smaller ( or even negative ) to bid higher . Theoretically , the additive form can be derived from a primal dual formulation . Specifically , we develop two real time bid adjustment approaches ( see Section 5 for the update formulae ) :
( a ) A control theoretic approach that adjusts the bid against constraint satisfaction level based on some error function . We present two forms of optimality control : ( 1 ) a proportional integral controller , and ( 2 ) an exponential form .
( b ) A statistical approach that estimates the distribution from which winning bids are drawn , and then derives the bid adjustment to achieve a desired winning probability , also based on the constraint satisfaction level .
We shall note that the impression valuation function as in Eq ( 1 ) is with respect to an advertiser and is not necessarily the same as the revenue function of a publisher ( think of a second price auction ) . To abstract from the complication of what auction to run , which itself is an open research issue [ 14 ] , we assume in our discussion a first price auction run in a one sided marketplace of advertisers , without loss of the generality of the basic approach . In this case , Eq ( 1 ) is equivalent to the revenue function . This simplifying assumption is removed in Section 6 when we develop more general bidding algorithms , eg , from an ad network point of view and in a second price auction . Indeed , in a standard auction in a one sided market as we assume , the revenue equivalence theorem states that first price , second price and several other auctions will all yield identical expected revenue in Bayesian equilibrium [ 10 ] . 2 . BACKGROUND
The primary theoretical foundation upon which the online bidding algorithms are grounded is LP duality . We briefly introduce the concepts fundamental to the derivation that follows . The standard form of a LP problem , referred to as a primal problem , is : x c x max st Ax ≤ b , x ≥ 0 .
( 4 )
Here x is a vector of n variables , c is a vector of n coefficients , and cx is the objective function . A is a m × n matrix of coefficients , b is a vector of m coefficients , and Ax ≤ b are the constraints , as well as the non negative variable constraints . A x is feasible if it satisfies all constraints , and is optimal if it gives the maximal value of the objective function among all feasibles .
The standard form can be equivalently converted into an augmented form by introducing a non negative slack variable for each of the m constraints to replace inequalities with equalities in the constraints . If the optimal value of a slack variable is zero in the augmented form , the corresponding inequality constraint in the stand form becomes tight in its optimal solution .
The primal problem can be converted into a dual problem : min y st A b y y ≥ c , y ≥ 0 .
( 5 )
Here y is a vector of m variables corresponding to the m constraints in the primal , and Ay ≥ c are the n constraints corresponding to the n primal variables . The weak duality theorem states that the dual problem provides an upper bound to the objective function of the primal , ie , cx ≤ by,∀ feasible x , y . The strong duality theorem states that if the primal has an optimal solution x∗ , then the dual also has an optimal solution y∗ , such that cx∗ = by∗ . Obviously , the primal and the dual are symmetric .
With the primal dual formulation , we now have a choice of solving either the primal or the dual first ( offline ) , according to the problem structure at hand ( eg , dimensionality and generality ) ; and then derive ( possibly online ) an optimal solution to one ( the primal ) when an optimal solution to the other ( the dual ) is known . There is a very useful necessary condition for optimality that facilitates this idea .
Theorem 1 . The complementary slackness theorem states :
Suppose that
1 . x = ( x1 , . . . , xn ) is a primal feasible , 2 . z = ( z1 , . . . , zn ) is the corresponding dual slack , 3 . y = ( y1 , . . . , ym ) is a dual feasible , and 4 . w = ( w1 , . . . , wm ) is the corresponding primal slack .
Then x and y are optimal for their respective problems if and only if :
1 . xizi = 0,∀i , and 2 . yjwj = 0,∀j .
The complementary slackness condition is a special case of the more general Karush Kuhn Tucker ( KKT ) conditions in convex optimization .
3 . PERFORMANCE DISPLAY OPTIMIZA
TION : A LP FORMULATION
To derive the basic algorithmic form for online bidding , and to establish its optimality , we begin by formulating the basic performance display ad optimization as a LP . In this basic setting , impressions are valuated and allocated individually , and the demand side constraints ( eg , budget limits ) are given in terms of impression delivery goal . This formulation shall capture all theoretical essences , and practical nuances are discussed in Section 6 . Let us first define the following notations :
1 . i indexes n impressions , and j indexes m campaigns ;
2 . pij denotes CTR of impression i assigned to campaign j , qj denotes CPC for campaign j , and vij = pijqj is the eCPI of such assignment ;
3 . gj is the impression delivery goal for campaign j ;
4 . xij is the decision variable indicating whether impression i is assigned to campaign j ( xij = 1 ) or not ( xij = 0 ) .
We formulate the following LP as the primal : i,j max x st ∀j ,
∀i , vijxij i xij ≤ gj , xij ≤ 1 , j xij ≥ 0 . j
βi i
The dual problem is then : min α,β gjαj + st ∀i , j , αj + βi ≥ vij ,
αj , βi ≥ 0 .
( 6 )
( 7 )
It is important to note that since an impression is by nature indivisible , the primal should actually be an integer programming problem , by adding the integer variable constraint xij ∈ {0 , 1} . However , as we show more rigorously in Section 4 , the optimal solution to the primal LP is indeed integral , given some nice structure of this basic setting , specifically the constraint matrix is totally unimodular ( TU ) . Even if the LP optimal solution is no longer integral , eg , using budget constraints directly instead of impression delivery goal , the LP relaxation will not pose any significant problems in practice . For impression i , a fractional optimal xij can be thought of as a probabilistic assignment , ie , assign impression i to campaign j with probability xij . Assume that there are sufficiently large amount of impressions identical to i ( to the extent a practical system can tell ) , then not only will the probabilistic assignment yield an integral solution , but also optimal for the LP . As a consequence , we can safely use algorithms to ensure an integral solution .
The dual variables have natural interpretations : αj is the economic value of acquiring an additional goal impression for campaign j ( eg , by increasing budget ) , and βi is the economic value of procuring an additional impression i for the publisher ( eg , by attracting more visits ) . We wish to derive an online algorithm to solve the primal LP , thus obtaining a delivery scheme xij,∀i , j . One may choose to solve the primal directly , as in the current practice of display ad allocation . In this case , the number of variables ( xij ) to learn is n × m . On the other hand , solving the dual only requires n + m variables ( αj , βi ) , orders of magnitude dimensionality reduction . The Occam ’s razor principle favors parsimonious models as the dual . The problems remaining are : ( 1 ) how to derive an optimal solution to the primal from the optimal solution to the dual , in an online fashion ; and ( 2 ) how to account for the non stationary nature of the distribution of impression arrivals . The bidding algorithm in Section 4 addresses the first problem , and the bid adjustment in Section 5 addresses the second problem .
4 . A REAL TIME BIDDING ALGORITHM Consider an online setting , where each impression i arrives from a stream , and a real time ad serving decision needs to be made , ie , the assignment of xij,∀j . For each incoming impression i , we will add m decision variables xij,∀j and one j xij ≤ 1 to the primal , one decision variable βi and m constraints αj + βi ≥ vij,∀j to the dual . Let us for now assume that the optimal αj,∀j are given . The constraint following online algorithm uses the complementary slackness theorem to assign variables such that the offline optimality is preserved .
Algorithm 1 : The basic real time bidding algorithm Input : qj , gj , αj,∀j Output : xij , βi,∀i , j begin
G ← ∅ ; foreach impression i from a stream do pij = p(click|i , j),∀j ; vij ← pijqj,∀j ; j∗ ← argmaxj∈G ( vij − αj ) ; if ( vij∗ − αj∗ ) > 0 then if xij∗ ← 1 ; xij ← 0,∀j = j∗ ; βi ← vij∗ − αj∗ ; i xij∗ = gj∗ then G ← G ∪ j∗ ; end end αj ← UpdateAlpha(αj),∀j ; end end
1 2 3 4 5
6
7 8 9 10 11 12 13
14 15
16
17
The basic idea conveyed by Algorithm 1 is the following . For an incoming impression i , each campaign j valuates it with vij = p(click|i , j)qj , and then bids on it with vij − αj . The winning bidder with positive bid gets the impression , and goal achieved campaigns j ∈ G will withdraw from future auctions . Here βi is for bookkeeping the economic value of impression i and is not critical to auction . The bid adjustment function αj ← UpdateAlpha(αj ) is to adapt αj ’s to the current goal delivery level and bidding environment . Under a stationary impression arrival assumption , it reduces to an identity function . We will implement the non stationary version in Section 5 . From an auction perspective , more interestingly , αj can be interpreted as the minimum profit ( revenue minus cost ) campaign j requires , and βi shall be proportional to the floor price demanded by the publisher who sells impression i .
We now establish the offline optimality of this basic online bidding algorithm under a stationary α assumption .
Theorem 2 . The optimality of the online bidding algorithm . Given the optimal bid adjustment αj,∀j , a first price auction with the following design guarantees the offline optimality .
1 . Every campaign j bids on an impression i with the amount vij − αj ;
2 . Only active campaigns , ie , ipate ; i xij < gj , can partic
3 . The impression is assigned if and only if the highest bid is positive .
Proof . Since a feasible solution exists ( eg , trivially set all variables to zero ) and the objective function is bounded , there exist optimal solutions . For each impression i , the winning bidder is j∗ = argmaxj∈G ( vij − αj ) . First , if the highest bid ( vij∗ −αj∗ ) > 0 , impression i must j xij < 1 is be assigned ; otherwise , the primal constraint
If j slack , and the corresponding dual variable βi = 0 , thus the dual constraint αj∗ + βi ≥ vij∗ contradicts . Then assign i = j∗ , to some j , so xij = 1 , and αj + βi = vij . ( vij∗ − αj∗ ) > ( vij − αj ) = βi assuming no ties in bidding , thus the constraint αj∗ + βi ≥ vij∗ contradicts . Therefore , the optimal solution contains xij∗ = 1 and xij = 0,∀j = j∗ . Second , if ( vij∗ − αj∗ ) < 0 , the impression i should be ignored ; otherwise , the tightened dual constraint αj + βi = vij corresponding to xij = 1 contradicts , since βi ≥ 0 . If ( vij∗ − αj∗ ) = 0 , there are multiple optimal solutions . i xij ≤ gj,∀j are satisfied by maintaining an active campaign set ¬G .
Third , the constraints
Finally , an impression with a positive highest bid must be all assigned ( even in a divisible sense ) to the highest bidder = j∗ gets assigned j∗ ; otherwise , if some losing bidder j some non zero impression ( eg , 0.2 impression ) , then the corresponding dual constraint tightened αj + βi = vij , and hence contradicts the highest bid proposition ( vij − αj ) = βi > ( vij∗−αj∗ ) assuming no ties in bidding . More formally , we can rewrite the primal constraints as in Eq ( 6 ) in the standard matrix form :
Im Im ··· Im
U1 U2 ··· Un
×
 x11 x1m x21 xnm
 ≤

 . g1 gm 1 1
( 8 )
Here Im is a m× m identity matrix , and there are n of them horizontally stacked . Ui,∀i is a n × m matrix with ones on the ith row and zeros elsewhere . The constraint matrix A is then a ( n + m ) × ( nm ) matrix . Now we can verify that A is totally unimodular ( TU ) . A unimodular matrix is a square integer matrix with determinant 1 or −1 , and a TU matrix is a matrix for which every square non singular submatrix is unimodular . It is known that if A is TU and b is integral , the LP of the standard form as in Eq ( 4 ) has integral optima .
5 . BID ADJUSTMENT
One simplifying assumption we made in the basic algorithm is that the distribution from which impressions are drawn is stationary , which means given sufficient historical data we can learn the optimal bid adjustment αj,∀j a priori by solving the dual offline . In practice , however , since the marketplace is dynamic , impression arrival is non stationary , eg , seasonality changes of supply . On the other hand , demand side valuation is also a non stationary process , eg , old campaigns expire and new campaigns begin . These nonstationarities will violate the complementary slackness condition , and hence the historically optimal αj ’s will not be optimal for future . Our approach is to initialize αj ’s with the offline optimal solution to the dual formulated with historical data , and then update αj ’s online to accommodate supply side dynamics and demand side constraint satisfaction level , through control theoretic or statistical methods . 5.1 Control theoretic Bid Adjustment
A simple control design is based on classical control theory , particularly we will use a proportional integral ( PI ) controller [ 2 ] , a commonly used form of the more generic t proportional integral derivative ( PID ) controller . It is known that , in the absence of knowledge of the underlying process , a PID controller is the best controller [ 3 ] . Formally , let t denote time , rj(t ) and r j(t ) are the desired and observed probabilities of winning bids , respectively , tracked at time t ; and ej(t ) = rj(t ) − r j(t ) is the error measured at time t . The PI controller takes the following form :
αj(t + 1 ) ← αj(t ) − k1ej(t ) − k2 ej(τ )dτ .
( 9 )
0
Here k1 is called proportional gain , and k2 is called integral gain , both are tuning parameters . In practice , time t needs not to be tracked instantaneously , for both online computational efficiency and the discrete nature of impression arrival . Instead , let t ∈ [ 1 , . . . , T ] indexes sufficiently small time intervals , where T is the number of intervals within the entire duration of online bidding ; and one only updates αj ’s once after each interval .
Another even simpler control approach is inspired by Waterlevel [ 4 ] , an online and fast approximation algorithm originally designed for resource allocation problems , such as delivering placement reserved display ads . The Waterlevelbased update formula is :
αj(t + 1 ) ← αj(t ) exp ( γ(xj(t)/gj − 1/T )),∀j ,
( 10 ) where xj(t ) denotes the number of impressions won by campaign j during time interval t ; and the exponent factor γ is a tuning parameter that controls how fast the algorithm responds to the error measured as xj(t)/gj−1/T . If the initial αj ’s ( eg , solved from the offline dual ) are indeed optimal for future runs , we want γ to be zero . Notice though , in the error term xj(t)/gj − 1/T we assume for clarity a uniform impression stream over time intervals . This assumption is not critical since it can be easily removed by adding a timedependent prior . Moreover , the Waterlevel based update has a nice chaining property :
αj(t + 1 ) = αj(t ) exp ( γ(xj(t)/gj − 1/T ) )
= αj(t − 1 ) exp
= . . .
= αj(1 ) exp
γ xj(τ )/gj − 2/T
( 11 )
. xj(τ )/gj − t/T
5.2 Model based Bid Adjustment
τ =1
The basic idea of our model based approach is drawn from modern control theory [ 9 ] , where a mathematical model of the state of the system ( the bidding marketplace in our case ) is utilized to produce a control signal ( the bid adjustment αj ’s in our case ) . More formally , we postulate a parametric distribution P on the winning bids as follows . w ∼ P(θ ) ,
( 12 ) where θ is the model parameter . We use the generic form since an appropriate parametric choice should be empirically justified by data , and likely domain dependent . Several reasonable choices are a log normal distribution [ 7 ] and a Gaussian distribution on the square root of winning bids [ 13 ] , but neither can handle negative bids naturally . In our additive form of bid adjustment as in Eq ( 3 ) , a negative bid bij = vij − αj < 0 would mean that the bidder cannot fulfill
γ t t
τ =t−1 its minimal margin by acquiring impression i , thus reveals a hidden part of the entire value book of the marketplace . We note the PDF as f ( w ; θ ) , the CDF as F ( w ; θ ) , and the inverse CDF as F −1(p ; θ ) . The MLE of the distribution parameter θ is derived from sufficient statistics of historical winning bids {w} , which can be readily updated online , eg , the first and second moments . With this statistical model of bidding landscape , we can derive the probability of winning by bidding with bij = vij − αj : p(w ≤ bij ) = f ( w ; θ)dw = F ( bij ; θ ) .
( 13 ) bij
−∞
It is unrealistic to assume that the winning bids for all impression i ’s follow a single distribution ( more likely a mixture model ) , thus we will fit a distribution P(θ ) for a group of homogeneous impressions , eg , from a placement . In practice , we align a P(θ ) with the impression granularity level at which both the supply side and demand side constraints the system wishes to enforce ( more on this in Section 6 ) . For now let us focus on homogeneous impressions .
We wish to link the learned winning probability with future bidding behavior to achieve the delivery goal . Suppose that rj is the expected or desired probability of winning the remaining impressions by campaign j to meet its goal gj . It is tempting to just bid with bij = F −1(rj ; θ ) on future impression i ’s . However , this purely goal based approach fails to use feedback explicitly to control future bids , thus losing the advantages that a so called closed loop controller ( eg , a PID controller ) would have , including stability and robustness to model uncertainty . In other words , the purely goal driven approach does not learn from the errors made by past bidding . We now propose a model based controller that addresses this limitation , while leveraging the knowledge learned about the bidding landscape . The bid adjustment formula is as follows .
αj(t + 1 ) ← αj(t ) − γ,F j(t)) ,∀j , ( 14 )
−1(rj(t ) ) − F
−1(r where rj(t ) and r j(t ) are desired and observed winning probabilities , respectively , measured at time t . The multiplicative factor γ is a tuning parameter that controls the rate at which an update responds to errors . Compared with classic approaches , a model based approach does not directly operate on measured errors ; instead it transforms an error signal ( winning probability error ) , through a compact model ( P(θ) ) , to a control signal ( updated αj ) .
It is also worth noting that in the absence of a good parametric distribution , a non parametric model can also be used in practice . One needs to maintain an empirical CDF as a two way lookup table ( F ( w ; D ) and F −1(p ; D ) ) for online inference .
6 . PERFORMANCE DISPLAY OPTIMIZATION : A PRACTICAL FORMULATION We have developed the basic algorithmic form in Algorithm 1 , and established its optimality given the stationary impression arrival assumption . In the basic LP formulation , constraints are encoded as impression delivery goal , and impressions are valuated and assigned individually . We now formulate the LP problem directly with business constraints , primarily demand side budget limits and supply side inventory availability ; and then discuss major practical aspects that a real world system shall take into consideration . Let us first update the following notations :
1 . i now indexes n impression groups ( eg , placements ) , impressions within one group are regarded as indistinguishable , and hence yield a same CTR estimation given a campaign ;
2 . gj is the budget cap for campaign j ;
3 . hi denotes the impression availability constraint or fore cast for group i ;
4 . xij now denotes the number of impressions from group i allocated to campaign j ;
5 . wi denotes the ( traffic acquisition ) cost per impression from group i , eg , the second price in a Vickrey auction .
Notice that we make CTR prediction and supply constraint at the same resolution , ie , per impression group . This is critical to avoid the so called cream skimming problem [ 11 ] . If CTR prediction is finer grained than supply constraint for instance , an optimization will always assign impressions to higher CTR opportunities within each impression group , which is obviously unrealistic . Also , we introduce the cost term wi to generalize the yield optimization to other players , eg , an ad network or demand side platform participating into a second price auction . The primal LP now becomes :
And the dual problem is :
By a similar derivation as in Section 4 , the following auc tion design would approach offline revenue optimality :
1 . Every campaign j bids on an impression from group i with the amount vij(1 − αj ) ;
2 . Only active campaigns , ie , ticipate ; i vijxij < gj , can par
3 . The impression is assigned only if the highest bid is greater than the cost wi , which is implied if wi only contains the second price .
The bid adjustment term αj can now be interpreted as the minimum profit margin ( profit divided by revenue ) a campaign requires . The cost term wi is constant with respect to each auction .
Since the primal constraint matrix A in Eq ( 15 ) is no longer TU with the valuation terms vij ’s introduced , the primal optimal is not necessarily integral . As we demonstrated in Section 4 , however , the LP relaxation is not a i,j i max x st ∀j ,
∀i , j xij ≥ 0 .
( vij − wi)xij vijxij ≤ gj , xij ≤ hi , j i min α,β gjαj + hiβi st ∀i , j , vijαj + βi ≥ vij − wi ,
αj , βi ≥ 0 .
( 15 )
( 16 ) concern in practice . One can solve the primal x∗ ij ’s , and then stochastically assign impressions from group i to campaign j with probability x∗ ij , referred to as proportional allocation . Many current practices follow this primal based approach [ 4 , 6 ] . ij/ j x∗
As one wishes to valuate impressions at a very fine grained level , the primal will soon become intractable ( recall the cream skimming problem ) . We propose a dual based approach as follows . First , the dual as in Eq ( 16 ) is solved offline using historical data . The offline optimal αj ’s are then used as the initial bid adjustment terms for future bidding . In online bidding , a centralized ad delivery system ( eg , owned by the publisher ) with perfect information ( eg , the historically optimal αj ’s ) bids on behalf of all advertisers , and adjusts αj ’s near real time based on observed constraint satisfaction level and bidding landscape , through approaches described in Section 5 . The dual has lower dimensionality to start with , ie , n + m model parameters instead of nm , thus conceived to have a better generality . What we seek from the dual is actually a partial solution , that is , αj ’s only , which only causes linear complexity of the offline solver . Furthermore , since we will adjust αj ’s dynamically anyway , a good approximation may suffice .
A practical algorithm shall take into consideration the following aspects . First , to avoid multimodality , one distribution density P(θ ) is estimated for one impression group that exhibits sufficient homogeneity , eg , a Gaussian distribution on winning bids per group w ∼ N ( µi , σ2 i ) to allow for negative bids . Since the purpose of the statistical model is to derive a constraint based bid from the desired winning probability based upon budget limit , the budget constraint gj needs to be given at the same impression group level at which the distribution is fit . However , constraints such as budget cap are naturally given at the campaign level across all impression groups . This issue can be addressed both offline and online . One can start with distributing offline a campaign level goal across impression groups with a prior proportion , and then synchronize online these campaigngroup level subgoals . More interestingly , the other part of the dual solution , namely βi ’s , shall guide this subgoal synchronization . If some βi becomes positive and larger , the inventory availability from impression group i becomes scarce , which suggests one shall move some delivery subgoals from group i to those with ampler resources and bid less aggressively for group i ( think of a reverse auction where impression groups bid for campaigns ) . Here we focus on predistributed campaign group level goals gj ’s .
Second , we consider a fully observed exchange where the winning bid ws is revealed after each auction . A partially observed setting differs in the penalty for a bidder to learn the distribution of winning bids , ie , wi will contain some exploration cost [ 7 ] . Third , the algorithm shall be implemented as an online listener , where each impression s arrives from a stream S one at a time . For online computational efficiency , only minimally required statistics are updated real time , specifically impression assignments , sample sizes , cumulative valuation , and moments for model parameter θ . Bid adjustment , along with its relevant parameter estimation , is performed near real time , only once after each time interval t ; so does campaign budget capping . These near real time updates may involve expensive computations such as inversing a CDF .
Finally , the estimated CTR psj , along with eCPI vsj and bid bsj , is made dependent upon individual impressions s . This is only for a bidder to randomize its bids , but not for cream skimming . The expected value of a randomized CTR should still be the group level CTR , ie , E(psj ) = pij,∀s ∈ i . Bid randomization has two advantages : ( 1 ) bidding ties can be naturally broken ( see the optimality theorem and its proof in Section 4 ) , and tie breaking is especially important in reserved ad allocation where valuations may largely overlap ; and ( 2 ) one can extend the optimal auction theory [ 15 ] to show that the revenue optimal mechanism for an ad network is to randomize its bids ( eg , by a uniform distribution ) within a certain range [ 14 ] .
7 . EXPERIMENTS
In this section , we discuss our empirical evaluation with the application of implicit targeting for performance display advertising [ 1 ] , using real world ad serving data . The goal of implicit targeting is to optimize revenue by leveraging finegrained impression level opportunities , such as user signals . Compared with explicit targeting , such as behavioral targeting [ 5 ] , the audience to target is not explicitly defined , but instead is identified via impression level valuation . The current approach to performance ad optimization is to solve a LP offline for determining ad assignment at the ( placement , campaign ) level , and to use a static proportional allocation scheme for online ad delivery . In implicit targeting , we wish to perform the LP optimization at the ( placement , user , campaign ) level , and to solve it online . Here a user is a user level feature vector that encodes signals relevant to predicting clicks . By distinguishing among users within a same placement , one shall expect higher revenue than treating them identical . In comparison with the current offline approach , the proposed online bidding algorithm for implicit targeting not only makes impression level valuation feasible , but also yields substantial computational advantage . Formally , we formulate the problem of implicit targeting as a LP similar to Eq ( 15 ) , with the following specializations .
1 . Campaign level budget constraints are given as im pression delivery goals gj ’s . ventory control
2 . An impression group i is defined as a ( placement , user ) tuple , at which level both CTR prediction pij and in j xij ≤ hi are performed .
3 . The cost term wi will be zero , since impressions are from owned inventory .
7.1 Data , Methodology and Metrics
We aim to empirically answer the following questions :
1 . Whether the online bidding algorithm can obtain the offline revenue optimality , given the optimal bid adjustment αj ?
2 . How different bid adjustment approaches perform , their optimality approximation , and control theoretic properties ?
3 . How significant is the initial value of αj , and to solve it offline with historical data ?
A proprietary data set of ad serving for one of the most trafficked placements is obtained from a large display network . There are on average 20M impressions served on each day , and four CPC campaigns involved . The raw log is processed into examples with the schema : ( timestamp , placement , user , campaign , clicks , impressions ) . For each example , let us denote the timestamp as t , the ( placement , user ) pair as i , the campaign as j , the clicks as cij(t ) , and the impressions as xij(t ) . When t is tracked instantaneously , an example shall correspond to a single impression assignment . For computational efficiency in our experiments , we trace timestamp in seconds , and hence the composite key ( t , i , j ) uniquely identifies an example . The impressions xij(t),∀t , i , j are the allocation results of the current production system based on a ( placement , campaign ) level LP optimization , thus aggregating impressions for each campaign j gives the t,i xij(t ) . The clicks cij(t ) are the ground truth feedbacks , thus divided by impressions gives the empirical CTR . For simulating revenue generated by the proposed approach , we are particularly interested in the empirical CTR for each ( placement , user , campaign ) tut cij ( t ) t xij ( t ) . One may ple marginalized over time , ie , pij = choose to use time dependent empirical CTR pij(t ) = cij ( t ) xij ( t ) to simulate revenue , but that would lead to noisy estimation due to the sparsity of xij(t ) . The sum of the products of clicks by CPC qj is the actual revenue yielded by the impression delivery goal gj = current approach y = t,i,j cij(t)qj . ume constraints ∀i ,
The online bidding algorithm is implemented as follows , similar to Algorithm 1 but with practical considerations as discussed in Section 6 . One first sorts examples by timestamp to form a stream . For each incoming example from ij,∀j , the stream , one predicts CTR for each campaign p regardless of the actual assigned campaign . Active camijqj − αj , where αj is initialpaigns then bid with bij = p ized as the dual optimal solved from historical data and updated online as bidding runs . The impressions associated with the example are re assigned to the winning bidder ij∗ ( t ) ← xij(t ) if bij∗ > 0 ; or j∗ = argmaxj ( bij ) , ie , x ignored if bij∗ ≤ 0 , . By so simulating , the impression volj xij ≤ hi are naturally satisfied , since all impressions already exist and one only changes the campaign assignments . The campaign level goals are checked real time after each auction , while αj ’s are updated near real time once after each hour , ie , T = 24 . The algorithm runs on a daily basis , and at the end of each day one will have ij(t),∀t , i , j . The simua simulated impression allocation x t,i,j x ij(t)pijqj , where pij is the empirical CTR instead of the predicted CTR . To evaluate the performance of different algorithms and bid adjustments , we use revenue lift defined as the ratio of simulated revenue to actual revenue : lated revenue is computed as y =
Revenue lift = y y
.
( 17 ) ij(t)pijqj
= t,i,j x t,i,j cij(t)qj ij(t)pij/ t,i,j cij(t)/ t,i,j x
By removing the CPC term , we can also report the overall CTR lift by the proposed approach :
CTR lift =
CTR CTR
= t,i,j x t,i,j xij(t ) ij(t )
.
( 18 )
A sensible implicit targeting algorithm shall have a revenue lift greater than one , and the offline optimal solution gives an upper bound lift to any online algorithm . 7.2 Results
Let us start with verifying the optimality of the online bidding algorithm . We take one day ad serving data , first solve both the primal and the dual LP offline to obtain the offline optimal revenue and αj ’s , and then simulate the online bidding on the same data using the optimal αj ’s without adjustment . As shown in Table 1 , the online algorithm achieves nicely the offline revenue optimality . The small variance is because this particular implementation allocates in batch impressions sharing a same composite key ( t , i , j ) to save computation , which may violate inventory constraints marginally . Although CTR is not the optimizing objective , the online algorithm yields higher CTR lift than offline . This is because the online algorithm only assigns impressions with positive winning bids , and may disregard perceived nonmonetizable ones ; while the offline solver does not concern as long as the constraints are satisfied .
Table 1 : Optimality of Online Bidding Revenue lift CTR lift
Methods
Offline optimal Online bidding
1.4811 1.4821
1.3180 1.4913
Figure 1 : Hourly delivery ratio against reference ity , one cannot know offline optimal values of αj ’s a priori . The results are shown in Table 3 .
Table 3 : Significance of Initial αj
We now evaluate different online bid adjustment approaches ,
Offline optimal
Revenue lift specifically the model based and the Waterlevel based control mechanisms ( shortcut as ModelBidder and WaterlevelBidder ) . Both uses historical optimal αj ’s as initial values solved from the day preceding the testing day , and we test on four consecutive days . The rate factor γ is set to 0.01 for ModelBidder , and 0.24 = 0.01T for WaterlevelBidder . The results are shown in Table 2 .
Table 2 : ModelBidder vs . WaterlevelBidder Revenue lift
Day1 Day2 Day3 Day4 1.3656 1.4811 1.4817 1.3598 1.2460 1.4681
1.3652 1.3683 1.3675
Offline optimal ModelBidder
WaterlevelBidder
1.4243 1.3936 1.3923
Both bid adjustment methods perform very well in approaching offline revenue optimality , with above 90 % offline optimal revenue lift achieved in all cases . The model based adjustment does slightly better in revenue lift . It is also important to examine the control theoretic properties of different adjustment algorithms , specifically the stability . Let us define the hourly delivery ratio of a campaign as the hourly winning impressions as a percentage of its daily delivery goal , and the reference ratio as the hourly impression arrivals as a percentage of the total daily impressions . A stable control strategy shall produce delivery ratios close to the reference ratio . We plot the delivery ratios of different adjustment methods against the reference ratio for one top campaign in terms of delivery goal on one day , as shown in Figure 1 . The Waterlevel based method shows superior stability since it directly operates on the error measured against the reference , while the model based exhibits greater oscillations . On the other hand , using static optimal αj does not react to the reference .
To investigate the significance of the initial value of αj and the merit of solving it offline with historical data , we simulate the Waterlevel based bid adjustment with different initial αj values , namely , ( 1 ) zero αj ’s , ( 2 ) historical optimal αj ’s , and ( 3 ) offline optimal αj ’s for the testing day . In real
Zero αj
Historical αj Optimal αj
Day1 Day2 Day3 Day4 1.4811 1.3656 1.4819 1.3652 1.4681 1.2460 1.3557 1.4638
1.4243 1.3984 1.3923 1.3973
1.3652 1.3696 1.3675 1.3655
Although all different choices approximate offline revenue optimality , varying initial value of αj makes no significant difference . We argue that this may be an artifact of offline simulation , where only offline data pre filtered by the current production system could be obtained . The actual impression allocation in the data has already gone through constraint enforcement by the current delivery system that produces the data ; and as a consequence , the delivery goal for the online bidding simulation will not be constraining enough to make αj significant at the beginning . In fact as empirically shown , all campaigns only exhaust their delivery goals towards the end of a daily run . In reality , when campaign budgets become much more constraining relative to the impressions available from an open exchange , a good initial αj will matter more .
To test the hypothesis of the pre selection bias of the offline data and to fully reveal the significance of the initial αj , we artificially constrain the campaign budget by a factor of λ ∈ [ 0 , 1 ] , thus the campaign delivery goal gj derived from the data becomes λgj . We experiment with λ = 90 % , 75 % , 50 % using the Waterlevel based bid update , and the results support the hypothesis , as shown in Tables 4 , 5 , and 6 . As campaign budget becomes smaller and delivery goal becomes more constraining , the performance of the zero αj initialization degrades considerably , while the historial or offline optimal αj largely preserves the offline revenue optimality . When campaign budget is cut by 50 % , a cold start with zero αj cannot even recover the revenue yielded by the current approach . These empirical results justify the cost of solving an offline dual LP to obtain a sensible αj initialization , especially under a constraining budget .
8 . CONCLUSIONS
Our contributions are a simple yet well grounded real time
012345678910111213141516171819202122232425000200400600801012014016018Hour of a dayDelivery ratio ReferenceWaterlevelBidderModelBidderOptimal α display ads . Proceedings of the 11th ACM Conference on Electronic Commerce ( EC 2010 ) , 2010 .
[ 5 ] Y . Chen , D . Pavlov , and J . F . Canny . Large scale behavioral targeting . ACM Conference on Knowledge Discovery and Data Mining ( KDD 2009 ) , pages 209–218 , 2009 .
[ 6 ] U . Feige , N . Immorlica , V . Mirrokni , and
H . Nazerzadeh . A combinatorial allocation mechanism with penalties for banner advertising . Proceeding of the 17th International World Wide Web Conference ( WWW 2008 ) , 2008 .
[ 7 ] A . Ghosh , B . I . P . Rubinstein , S . Vassilvitskii , and
M . Zinkevich . Adaptive bidding for display advertising . Proceedings of the 18th International World Wide Web Conference ( WWW 2009 ) , pages 251–260 , 2009 .
[ 8 ] T . Graepel , J . Q . Candela , T . Borchert , and
R . Herbrich . Web scale Bayesian click through rate prediction for sponsored search advertising in Microsoft ’s Bing search engine . Proceedings of the 27th International Conference on Machine Learning ( ICML 2010 ) , pages 13–20 , 2010 .
[ 9 ] C . Kilian . Modern Control Technology . Delmar
Cengage Learning , 2005 .
[ 10 ] P . Klemperer . Auction theory : a guide to the literature . Journal of Economic Surveys , 13(3):227–286 , 1999 .
[ 11 ] J J Laffont and J . Tirole . Optimal bypass and cream skimming . American Economic Review , 80(5):1042–1061 , 1999 .
[ 12 ] P . Lu , S . hua Teng , and C . Yu . Truthful auctions with optimal profit . Workshop on Internet and Network Economics ( WINE 2006 ) , pages 27–36 , 2006 .
[ 13 ] V . Mirrokni , S . Muthukrishnan , and U . Nadav .
Quasi proportional mechanisms : prior free revenue maximization . arXivs , 2009 .
[ 14 ] S . Muthukrishnan . Ad exchanges : research issues .
Workshop on Internet and Network Economics ( WINE 2009 ) , pages 1–12 , 2009 .
[ 15 ] R . B . Myerson . Optimal auction design . Mathematics of Operations Research , 6(1):58–73 , 1981 .
Table 4 : Constraining budget by 90 %
Revenue lift
Offline optimal
Zero αj
Historical αj Optimal αj
Day1 Day2 Day3 Day4 1.4814 1.3300 1.3368 1.2587 1.4507 1.1123 1.3269 1.3406
1.3930 1.2797 1.3795 1.3824
1.3652 1.2562 1.2536 1.3218
Table 5 : Constraining budget by 75 %
Revenue lift
Offline optimal
Zero αj
Historical αj Optimal αj
Day1 Day2 Day3 Day4 1.4813 1.2858 1.0796 1.0953 1.4599 1.1092 1.2694 1.3658
1.3540 1.0789 1.3431 1.3526
1.3652 1.0671 1.3380 1.3480
Table 6 : Constraining budget by 50 %
Revenue lift
Offline optimal
Zero αj
Historical αj Optimal αj
Day1 Day2 Day3 Day4 1.4815 1.2702 0.7194 0.7315 1.2252 1.4792 1.4425 1.2228
1.3248 0.7076 1.3181 1.1277
1.3655 0.7300 1.1330 1.3555 bidding algorithm for performance display ad allocation , its theoretical revenue optimality guarantee , and practical approaches to adapting bids to market dynamics . We have provided a general framework of bidding in performancebased marketplace , where both impression valuation and constraints are taken into consideration to come up with an optimal bid . Further online experiments are desired to understand bid adjustment behavior even better , particularly to investigate the significance of several sources of model uncertainties including impression valuation and bidding landscape distribution . Finally , it will be of great interest to examine the equilibrium properties of the proposed bidding framework at an exchange , and particularly to compare the proposed bidding algorithms with other auction mechanisms with heterogeneous valuations [ 12 , 13 ] .
9 . ACKNOWLEDGMENTS
We wish to thank Paul Gorman , Peng Han , Marc Diamond , Asaf Aharoni , and Ishai Oren for many inspirational technical discussions ; and Padhraic Smyth for scientific guidance .
10 . REFERENCES [ 1 ] D . Agarwal , R . Agrawal , R . Khanna , and N . Kota .
Estimating rates of rare events with multiple hierarchies through scalable log linear models . Proceedings of the 16th ACM SIGKDD International Conference on Knowledge Discovery and Data Mining ( KDD 2010 ) , pages 213–222 , 2010 .
[ 2 ] K . J . Astrom and R . M . Murray . Feedback Systems :
An Introduction for Scientists and Engineers . Princeton University Press , 2008 .
[ 3 ] S . Bennett . A History of Control Engineering ,
1930 1955 . IET , 1993 .
[ 4 ] D . Charles , M . Chickering , N . R . Devanur , K . Jain , and M . Sanghi . Fast algorithms for finding matchings in lopsided bipartite graphs with applications to
